<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pemetaan - SPK ISPO</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <style>
        /* BASE STYLES & HEADER/SIDEBAR */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: #f4f6f9; color: #000; }

        .dashboard-header {
            background: linear-gradient(90deg, #2E7D32, #3498db); color: #fff; padding: 20px 30px;
            display: flex; justify-content: space-between; align-items: center; position: fixed;
            top: 0; left: 240px; right: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .page-header-title { font-size: 1.6rem; font-weight: 600; margin: 0; }
        .user-profile { display: flex; align-items: center; color: #fff; text-decoration: none; cursor: pointer; }
        .user-profile i { font-size: 2rem; margin-right: 10px; }
        .user-profile span { font-weight: 500; font-size: 1rem; line-height: 1; }

        .sidebar { width: 240px; height: 100vh; position: fixed; top: 0; left: 0; background: #fff; overflow-y: auto; }
        .sidebar .logo { background: #fff; text-align: center; padding: 20px; display: block; gap: 0; }
        .sidebar .logo img { width: 80px; display: block; margin: 0 auto; }
        .logo-text { font-size: 0.75rem; font-weight: 600; color: #000; margin-top: 10px; text-align: center; }
        .menu-container {
            background: #2E7D32; border-top-left-radius: 35px; border-top-right-radius: 35px;
            padding: 20px 0; margin-top: 20px; min-height: calc(100vh - 140px); display: block; gap: 0;
        }
        .menu-container h6 {
            font-size: 0.85rem; font-weight: 700; padding: 10px 20px; margin: 10px 0 5px 0;
            color: #fff; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .menu-container a {
            display: flex; align-items: center; padding: 12px 20px; color: #fff; text-decoration: none;
            border-radius: 25px; margin: 5px 15px; font-size: 0.9rem; font-weight: 500; transition: all 0.3s ease;
        }
        .menu-container a i { margin-right: 12px; font-size: 1.1rem; width: 20px; text-align: center; }
        .menu-container a:hover { background: #1b5e20; color: #fff; transform: translateX(5px); }
        .menu-container a.active { background: #fff; color: #2E7D32; font-weight: 600; }

        /* ISI KONTEN UTAMA */
        .main-content { margin-left: 240px; margin-top: 80px; padding: 30px; min-height: calc(100vh - 80px); }
        .map-card {
            background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            max-width: 1200px; margin: 0 auto;
        }

        /* --- STYLE UNTUK TAMPILAN PENCARIAN & DETAIL (PEMETAAN 1.JPG) --- */
        .search-container { margin-bottom: 30px; }
        .search-input {
            width: 100%; padding: 15px 20px 15px 50px; border: 1px solid #ddd; border-radius: 10px;
            font-size: 1rem; background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3C!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--%3E%3Cpath fill='%239e9e9e' d='M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.1-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z'/%3E%3C/svg%3E") no-repeat 15px center;
            background-repeat: no-repeat; background-position: 15px center; background-size: 20px;
            color: #555; outline: none; transition: border-color 0.3s;
        }
        
        .map-detail-container { 
            display: flex; gap: 20px; flex-wrap: wrap; 
            margin-bottom: 30px;
        }
        .map-image-box { flex: 2; min-width: 300px; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
        .map-image-box img { width: 100%; height: auto; display: block; }
        .detail-kebun-box { flex: 1; min-width: 250px; padding: 20px; border: 1px solid #eee; border-radius: 10px; background-color: #f9f9f9; }
        .detail-kebun-box h4 { font-size: 1.3rem; font-weight: 600; margin-bottom: 10px; color: #2E7D32; }
        .detail-kebun-box p { font-size: 0.95rem; line-height: 1.6; margin-bottom: 5px; }
        .detail-kebun-box p strong { font-weight: 500; color: #333; }
        .detail-kebun-box a { display: inline-block; margin-top: 15px; color: #2E7D32; font-weight: 600; text-decoration: none; font-size: 0.95rem; transition: color 0.3s; }
        
        .map-buttons { display: flex; justify-content: flex-end; gap: 20px; margin-top: 30px; }
        .btn-lokasi-baru, .btn-tutup {
            padding: 12px 35px; border-radius: 8px; font-size: 0.95rem; font-weight: 500; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;
        }
        .btn-lokasi-baru { background: #2E7D32; color: #fff; }
        .btn-lokasi-baru:hover { background: #1b5e20; }
        .btn-tutup { background: #E74C3C; color: #fff; }
        .btn-tutup:hover { background: #C0392B; }

        /* --- STYLE UNTUK TAMPILAN TAMBAH LOKASI KEBUN BARU (PEMETAAN 2.JPG) --- */
        .form-title { font-size: 1.8rem; font-weight: 600; margin-bottom: 30px; text-align: center; color: #333; }
        .form-grid-container { display: flex; gap: 30px; }
        .form-left { flex: 1; display: flex; flex-direction: column; gap: 20px; }
        .form-group label { font-weight: 500; font-size: 0.95rem; display: block; margin-bottom: 5px; text-transform: capitalize; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px;
            font-size: 1rem; transition: border-color 0.3s;
        }
        .form-right { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; }
        .map-preview {
            width: 100%; height: 350px; border: 1px solid #ccc;
            border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; background-color: #f0f0f0;
        }
        /* Style untuk menampilkan koordinat yang sudah dipilih */
        #displayCoords { font-size: 0.9rem; font-style: italic; color: #555; margin-top: 5px;}

        .btn-ambil-lokasi { background: none; border: none; color: #2E7D32; font-weight: 600; cursor: pointer; padding: 5px 0; font-size: 0.95rem; align-self: flex-end; }
        .btn-simpan-container { margin-top: 30px; display: flex; justify-content: flex-end; }
        .btn-simpan {
            padding: 12px 35px; border-radius: 8px; font-size: 0.95rem; font-weight: 500; border: none; cursor: pointer;
            background: #2E7D32; color: #fff; transition: all 0.3s ease;
        }
        
        /* Gaya untuk Peta di dalam Modal */
        #map { width: 100%; height: 400px; border-radius: 8px; }
        #selectedCoords { font-size: 1rem; font-weight: 600; color: #333; margin-top: 10px; }

        /* Responsive */
        @media (max-width: 992px) { .form-grid-container { flex-direction: column; } .btn-simpan-container { justify-content: center; } }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); } .dashboard-header { left: 0; }
            .main-content { margin-left: 0; } .map-detail-container { flex-direction: column; }
            .map-buttons { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <h2 class="page-header-title">Pemetaan</h2>
        <div class="user-profile">
            <i class="fa-solid fa-user-circle"></i>
            <span>Pekebun</span>
        </div>
    </div>
    <div class="sidebar">
        <div class="logo">
            <img src="logo-bengkalis.jpg" alt="Logo Bengkalis">
            <p class="logo-text">SPK & Pemetaan ISPO</p>
        </div>
        <div class="menu-container">
            <h6>Home</h6>
            <a href="dashboard_pekebun.html">
                <i class="fa-solid fa-house"></i> Dashboard
            </a>
            <h6>Menu</h6>
            <a href="input_data_lengkap.html">
                <i class="fa-solid fa-database"></i> Input Data Lengkap
            </a>
            <a href="pemetaan.html" class="active">
                <i class="fa-solid fa-map"></i> Pemetaan
            </a>
            <a href="hasil_spk.html">
                <i class="fa-solid fa-chart-line"></i> Hasil SPK
            </a>
        </div>
    </div>

    <div class="main-content">
        <div class="map-card">
            
            <div id="content-pencarian">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Cari Lokasi Kebun...">
                </div>
                
                <div class="map-detail-container">
                    <div class="map-image-box">
                        <img src="https://via.placeholder.com/800x400/81c784?text=Peta+Kebun+Sawit" alt="Peta Lokasi Kebun">
                    </div>
                    <div class="detail-kebun-box">
                        <h4>Kebun Umbang</h4>
                        <p>Luas: <strong>3.5 ha</strong></p>
                        <p>Status Lahan: <strong>Milik</strong></p>
                        <p>Tahun Tanam: <strong>2015</strong></p>
                        <p>Umur Tanam: <strong>8 tahun</strong></p>
                        <p>Status Dokumen: <strong>Diverifikasi</strong></p>
                        <a href="#">&gt; Hasil SPK</a>
                    </div>
                </div>

                <div class="map-buttons">
                    <button type="button" class="btn-lokasi-baru" onclick="showContent('content-tambah-lokasi')">
                        <i class="fa-solid fa-plus"></i> Lokasi Kebun Baru
                    </button>
                    <button type="button" class="btn-tutup">Tutup</button>
                </div>
            </div>
            
            <div id="content-tambah-lokasi" style="display: none;">
                <h1 class="form-title">Tambah Lokasi Kebun Baru</h1>
                
                <form id="tambahLokasiForm">
                    <div class="form-grid-container">
                        <div class="form-left">
                            <div class="form-group"> <label for="namaKebun">Nama Kebun</label> <input type="text" id="namaKebun" required placeholder="Contoh: Kebun Riau 1"> </div>
                            <div class="form-group"> <label for="lokasiKebun">Desa/Kecamatan</label> <input type="text" id="lokasiKebun" required placeholder="Contoh: Desa Sejahtera"> </div>
                            <div class="form-group"> <label for="luasLahan">Luas Lahan (Ha)</label> <input type="number" id="luasLahan" required placeholder="Contoh: 4.5"> </div>
                            <div class="form-group">
                                <label for="statusISPO">Status ISPO</label>
                                <select id="statusISPO" required>
                                    <option value="belum">Belum ISPO</option>
                                    <option value="proses">Proses</option>
                                    <option value="sudah">Sudah ISPO</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-right">
                            <input type="hidden" id="latitudeInput" value="">
                            <input type="hidden" id="longitudeInput" value="">
                            
                            <button type="button" class="btn-ambil-lokasi" data-bs-toggle="modal" data-bs-target="#mapModal"> 
                                + Ambil Lokasi dari GPS GIS 
                            </button>
                            <div class="map-preview">
                                <p id="displayCoords">Belum ada lokasi dipilih</p>
                            </div>
                            
                        </div>
                    </div>

                    <div class="btn-simpan-container">
                        <button type="button" class="btn-tutup" style="margin-right: 20px;" onclick="showContent('content-pencarian')"> Batal </button>
                        <button type="submit" class="btn-simpan">Simpan</button>
                    </div>
                </form>
            </div>

        </div>
    </div>
    
    <div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mapModalLabel">Pilih Lokasi Kebun</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="map"></div>
                    <div class="text-center mt-3">
                        <p>Koordinat Terpilih: <span id="selectedCoords">0.000000, 0.000000</span></p>
                        <small class="text-muted">Klik peta atau geser penanda untuk memilih lokasi.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-success" id="saveLocationBtn">Simpan Lokasi</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // --- LOGIKA UTAMA TAMPILAN ---
        function showContent(contentIdToShow) {
            document.getElementById('content-pencarian').style.display = 'none';
            document.getElementById('content-tambah-lokasi').style.display = 'none';
            document.getElementById(contentIdToShow).style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', () => {
            showContent('content-pencarian');
            // Menambahkan event listener untuk tombol Ambil Lokasi, agar modal muncul
            document.querySelector('.btn-ambil-lokasi').addEventListener('click', function() {
                // Modal akan otomatis muncul karena data-bs-toggle
            });
            
            // Event listener submit form (simulasi penyimpanan)
            document.getElementById('tambahLokasiForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const latitude = document.getElementById('latitudeInput').value;
                const longitude = document.getElementById('longitudeInput').value;
                const namaKebun = document.getElementById('namaKebun').value;
                
                if (!latitude || !longitude) {
                     alert('Harap Ambil Lokasi (Koordinat) Kebun terlebih dahulu!');
                     return;
                }
                
                alert(`✅ Data Kebun Baru Berhasil Disimpan!\nNama Kebun: ${namaKebun}\nLokasi: Lat: ${latitude}, Lng: ${longitude}`);
                // Di sini Anda bisa mengirim data ke server (AJAX/Fetch)
                showContent('content-pencarian'); // Kembali ke tampilan awal
                document.getElementById('tambahLokasiForm').reset();
                document.getElementById('displayCoords').textContent = 'Belum ada lokasi dipilih';
            });
        });


        // --- LOGIKA GOOGLE MAPS ---
        let map;
        let marker;
        // Default koordinat (Contoh: Pekanbaru, Riau, Indonesia)
        let currentLat = 0.5332; 
        let currentLng = 101.4475;

        // FUNGSI INTI GOOGLE MAPS - DIPANGGIL OLEH API SETELAH KUNCI VALID
        window.initMap = function() {
            const defaultLocation = { lat: currentLat, lng: currentLng };
            
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                 console.error("Elemen 'map' tidak ditemukan di DOM.");
                 return;
            }

            map = new google.maps.Map(mapElement, {
                zoom: 12,
                center: defaultLocation,
                mapTypeId: 'satellite' // Menggunakan tampilan satelit
            });

            marker = new google.maps.Marker({
                position: defaultLocation,
                map: map,
                draggable: true, // Penanda bisa digeser
                title: "Lokasi Kebun"
            });

            // 1. Event listener saat marker digeser (Drag)
            google.maps.event.addListener(marker, 'dragend', function(event) {
                updateCoordinates(event.latLng.lat(), event.latLng.lng());
            });

            // 2. Event listener saat peta diklik
            map.addListener('click', function(event) {
                marker.setPosition(event.latLng);
                updateCoordinates(event.latLng.lat(), event.latLng.lng());
            });

            updateCoordinates(currentLat, currentLng);
        }

        // Fungsi untuk memperbarui nilai koordinat sementara di Modal
        function updateCoordinates(lat, lng) {
            currentLat = lat;
            currentLng = lng;
            document.getElementById('selectedCoords').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }

        // Event listener saat Modal dibuka (PENTING: Memastikan peta dirender setelah modal siap)
        const mapModalEl = document.getElementById('mapModal');
        mapModalEl.addEventListener('shown.bs.modal', function () {
            if (map) {
                // Solusi: Tambahkan penundaan singkat (100ms) untuk mengatasi masalah "peta tidak muncul" di modal
                setTimeout(() => {
                    google.maps.event.trigger(map, 'resize');
                    
                    // Gunakan koordinat yang sudah ada di input jika sudah pernah dipilih
                    const savedLat = parseFloat(document.getElementById('latitudeInput').value) || currentLat;
                    const savedLng = parseFloat(document.getElementById('longitudeInput').value) || currentLng;

                    const centerLoc = new google.maps.LatLng(savedLat, savedLng);
                    map.setCenter(centerLoc);
                    marker.setPosition(centerLoc);
                    updateCoordinates(savedLat, savedLng);
                }, 100); 
            }
        });

        // Event listener tombol 'Simpan Lokasi'
        document.getElementById('saveLocationBtn').addEventListener('click', function() {
            // Menyimpan koordinat AKHIR ke input tersembunyi
            document.getElementById('latitudeInput').value = currentLat;
            document.getElementById('longitudeInput').value = currentLng;
            
            // Menampilkan di area preview
            document.getElementById('displayCoords').textContent = `Lat: ${currentLat.toFixed(6)}, Lng: ${currentLng.toFixed(6)}`;

            // Menutup modal
            const mapModal = bootstrap.Modal.getInstance(mapModalEl);
            mapModal.hide();
        });
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"></script> 
</body>
</html>